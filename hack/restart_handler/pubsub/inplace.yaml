apiVersion: jobset.x-k8s.io/v1alpha2
kind: JobSet
metadata:
  name: inplace6
spec:
  replicatedJobs:
  - name: workers
    replicas: 1
    template:
      spec:
        parallelism: 3
        completions: 3
        backoffLimit: 0
        template:
          spec:
            restartPolicy: Never
            containers:
            - name: wrapper
              image: python:3.10
              env:
              - name: USER_COMMAND
                value: "sleep 1000"
              - name: POD_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.name
              - name: REDIS_HOST
                value: redis-headless # from redis.yaml
              - name: REDIS_PORT
                value: "6379"
              - name: JOBSET_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.annotations['jobset.sigs.k8s.io/jobset-name']
              command: 
                - bash
                - -xc
                - |
                  curl https://raw.githubusercontent.com/danielvegamyhre/jobset/script/hack/restart_handler/pubsub/restart_handler.py > restart_handler.py
                  python3 -m pip install kubernetes redis
                  python3 restart_handler.py
